name: ‚ôæÔ∏è Heal The Art MVP

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: write

jobs:
  heal-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõ∞Ô∏è Step 1: Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Step 2: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üîç Step 3: Find, Validate & Audit
        run: |
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          if [ -z "$TARGET_FILE" ]; then echo "‚ùå tokens.json not found"; exit 1; fi

          python -m json.tool "$TARGET_FILE"

          if grep -qE "AKIA[0-9A-Z]{16}" "$TARGET_FILE"; then SEC="FAIL"; else SEC="OK"; fi
          if grep -qiE "master|slave" "$TARGET_FILE"; then HR="WARN"; else HR="OK"; fi
          [ -f "LICENSE" ] && LEG="OK" || LEG="FAIL"

          echo "SEC_RES=$SEC" >> $GITHUB_ENV
          echo "HR_RES=$HR" >> $GITHUB_ENV
          echo "LEG_RES=$LEG" >> $GITHUB_ENV
          echo "FINAL_PATH=$TARGET_FILE" >> $GITHUB_ENV

      - name: üñ•Ô∏è Step 4: Update index.html Dashboard
        run: |
          sed -i "s/{{SEC_AUDIT}}/${SEC_RES}/g" index.html
          sed -i "s/{{HR_AUDIT}}/${HR_RES}/g" index.html
          sed -i "s/{{LEGAL_AUDIT}}/${LEG_RES}/g" index.html
          sed -i "s/{{LAST_RUN}}/$(date '+%Y-%m-%d %H:%M:%S')/g" index.html

      - name: üîê Step 5: AWS Authentication (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::249746593588:role/DesignSystemStack-CustomS3AutoDeleteObjectsCustomRe-wK8fy5Wb6uJl
          aws-region: us-east-1
          audience: sts.amazonaws.com

      - name: üöÄ Step 6: Minify & Sync to S3
        run: |
          python - <<EOF
import json
data=json.load(open("${FINAL_PATH}"))
json.dump(data, open("tokens.min.json","w"), separators=(",",":"))
EOF

          BUCKET="designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f"

          aws s3 cp "${FINAL_PATH}" s3://$BUCKET/tokens.json
          aws s3 cp tokens.min.json s3://$BUCKET/tokens.min.json
          aws s3 cp index.html s3://$BUCKET/index.html

      - name: üîÑ Step 7: Commit Dashboard Update (only if changed)
        run: |
          git config --global user.name 'AI-Auditor'
          git config --global user.email 'actions@github.com'

          git add index.html
          if ! git diff --cached --quiet; then
            git commit -m 'ü§ñ AI Dashboard Sync: Healed Architecture'
            git push
          else
            echo "No changes to commit"
          fi
