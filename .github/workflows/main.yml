name: ‚ôæÔ∏è Heal The Art MVP

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: write

jobs:
  heal-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üõ∞Ô∏è Step 1: Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Step 2: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üîç Step 3: Find, Validate & Audit
        run: |
          # DYNAMIC SEARCH: Find tokens.json even with spaces in folders
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          if [ -z "$TARGET_FILE" ]; then echo "‚ùå tokens.json not found"; exit 1; fi
          
          # Validation
          python -m json.tool "$TARGET_FILE"
          
          # Simple Security/HR/Legal Audit
          if grep -qE "AKIA[0-9A-Z]{16}" "$TARGET_FILE"; then SEC="‚ùå FAIL"; else SEC="‚úÖ OK"; fi
          if grep -qiE "master|slave" "$TARGET_FILE"; then HR="‚ö†Ô∏è WARN"; else HR="‚úÖ OK"; fi
          [ -f "LICENSE" ] && LEG="‚úÖ OK" || LEG="‚ùå FAIL"
          
          # Store results for the Dashboard
          echo "SEC_RES=$SEC" >> $GITHUB_ENV
          echo "HR_RES=$HR" >> $GITHUB_ENV
          echo "LEG_RES=$LEG" >> $GITHUB_ENV
          echo "FINAL_PATH=$TARGET_FILE" >> $GITHUB_ENV

      - name: üñ•Ô∏è Step 4: Update index.html Dashboard
        run: |
          # This 'Heals' the index.html by replacing placeholders
          sed -i "s/{{SEC_AUDIT}}/${{ env.SEC_RES }}/g" index.html
          sed -i "s/{{HR_AUDIT}}/${{ env.HR_RES }}/g" index.html
          sed -i "s/{{LEGAL_AUDIT}}/${{ env.LEG_RES }}/g" index.html
          sed -i "s/{{LAST_RUN}}/$(date)/g" index.html

      - name: üîê Step 5: AWS Authentication (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::249746593588:role/DesignSystemStack-CustomS3AutoDeleteObjectsCustomRe-wK8fy5Wb6uJl
          aws-region: us-east-1
          audience: sts.amazonaws.com

      - name: üöÄ Step 6: Minify & Sync to S3
        run: |
          # Generate tokens.min.json
          python -c "import json; data=json.load(open('${{ env.FINAL_PATH }}')); json.dump(data, open('tokens.min.json', 'w'), separators=(',', ':'))"
          
          # Sync everything to S3
          aws s3 cp "${{ env.FINAL_PATH }}" s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.json
          aws s3 cp tokens.min.json s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.min.json
          aws s3 cp index.html s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/index.html

      - name: üîÑ Step 7: Push Dashboard Update back to Git
        run: |
          git config --global user.name 'AI-Auditor'
          git config --global user.email 'actions@github.com'
          git add index.html
          git commit -m 'ü§ñ AI Dashboard Sync: Healed Architecture' || echo 'No changes'
          git push
