name: Heal The Art Pipeline

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›°ï¸ Step 1: Checkout
        uses: actions/checkout@v4

      - name: ğŸ Step 2: Python Setup
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ” Step 3: Find and Minify
        run: |
          # Find tokens.json anywhere in the repo
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          if [ -z "$TARGET_FILE" ]; then echo "tokens.json not found"; exit 1; fi
          
          # Validate and Minify
          python -m json.tool "$TARGET_FILE"
          python -c "import json; data=json.load(open('$TARGET_FILE')); json.dump(data, open('tokens.min.json', 'w'), separators=(',', ':'))"
          
          # Store path for next steps
          echo "FINAL_PATH=$TARGET_FILE" >> $GITHUB_ENV

      - name: ğŸ” Step 4: AWS Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::249746593588:role/DesignSystemStack-CustomS3AutoDeleteObjectsCustomRe-wK8fy5Wb6uJl
          aws-region: us-east-1
          audience: sts.amazonaws.com

      - name: ğŸš€ Step 5: S3 Upload
        run: |
          aws s3 cp "${{ env.FINAL_PATH }}" s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.json
          aws s3 cp tokens.min.json s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.min.json
