name: ‚ôæÔ∏è Heal The Art: AI Audit & AWS Push

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # This block is MANDATORY for AWS OIDC to work
    permissions:
      id-token: write   # Allows requesting the JWT from GitHub
      contents: write   # Allows the bot to update index.html and push to repo

    steps:
      - name: üõ∞Ô∏è Step 1: Checkout Code
        uses: actions/checkout@v4

      - name: üêç Step 2: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: üîç Step 3: Validate & Minify JSON
        run: |
          # Robust search for the file regardless of spaces in folder names
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "‚ùå Error: Could not find tokens.json!"
            exit 1
          fi
          
          # Validate format
          python -m json.tool "$TARGET_FILE"
          
          # Generate minified version in the root for speed
          python -c "import json; data=json.load(open('$TARGET_FILE')); json.dump(data, open('tokens.min.json', 'w'), separators=(',', ':'))"
          echo "TARGET_PATH=$TARGET_FILE" >> $GITHUB_ENV

      - name: üîê Step 4: AWS Authentication (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Use the full ARN to avoid the 'Source Account ID' error
          role-to-assume: arn:aws:iam::249746593588:role/DesignSystemStack-CustomS3AutoDeleteObjectsCustomRe-wK8fy5Wb6uJl
          aws-region: us-east-1

      - name: üöÄ Step 5: Sync to S3
        run: |
          # Pushes both the human-readable and the minified version to AWS
          aws s3 cp "${{ env.TARGET_PATH }}" s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.json
          aws s3 cp tokens.min.json s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.min.json

      - name: üì¶ Step 6: Upload Artifact (For Debugging)
        uses: actions/upload-artifact@v4
        with:
          name: design-tokens-minified
          path: tokens.min.json
