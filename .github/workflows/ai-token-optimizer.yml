name: ‚ôæÔ∏è Deep Audit & Improvement Loop

on:
  push:
    branches: [ main ]

jobs:
  audit-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üõ∞Ô∏è Step 1: Initialize
        uses: actions/checkout@v4

      - name: üîí Step 2: Security Audit
        id: security_audit
        run: |
          # Check for high-risk patterns like AWS keys or generic API tokens
          if grep -qE "AKIA[0-9A-Z]{16}|[a-zA-Z0-9+/]{40}" tokens.json; then
            echo "RESULT=‚ùå FAILED: Potential Secret Detected!" >> $GITHUB_ENV
          else
            echo "RESULT=‚úÖ PASSED: No Secrets Found." >> $GITHUB_ENV
          fi

      - name: ü§ù Step 3: HR & Inclusivity Audit
        id: hr_audit
        run: |
          # Scanning for non-inclusive terms
          BAD_WORDS="master|slave|blacklist|whitelist"
          if grep -qiE "$BAD_WORDS" tokens.json; then
            echo "HR_RESULT=‚ö†Ô∏è WARNING: Non-inclusive terms detected." >> $GITHUB_ENV
          else
            echo "HR_RESULT=‚úÖ PASSED: Content is inclusive." >> $GITHUB_ENV
          fi

      - name: ‚öñÔ∏è Step 4: Legal Framework Audit
        id: legal_audit
        run: |
          # Checks for a License declaration in the root
          if [ -f "LICENSE" ]; then
            echo "LEGAL_RESULT=‚úÖ PASSED: License file present." >> $GITHUB_ENV
          else
            echo "LEGAL_RESULT=‚ùå FAILED: Missing Legal License!" >> $GITHUB_ENV
          fi

      - name: üñ•Ô∏è Step 5: Real-Time Dashboard Update
        run: |
          # This script "Heals" the index.html by injecting the audit results
          python -c "
          import os
          html_path = 'index.html'
          with open(html_path, 'r') as f:
              content = f.read()
          
          # Replace placeholders in your index.html with real-time data
          content = content.replace('{{SEC_AUDIT}}', os.getenv('RESULT'))
          content = content.replace('{{HR_AUDIT}}', os.getenv('HR_RESULT'))
          content = content.replace('{{LEGAL_AUDIT}}', os.getenv('LEGAL_RESULT'))
          content = content.replace('{{LAST_RUN}}', '$(date)')
          
          with open(html_path, 'w') as f:
              f.write(content)
          "

      - name: üîÑ Step 6: Deploy & Close Loop
        run: |
          git config --global user.name 'AI-Auditor'
          git config --global user.email 'actions@github.com'
          git add index.html
          git commit -m 'ü§ñ AI Dashboard Update: Syncing Real-Time Audit Results' || echo 'No changes'
          git push
