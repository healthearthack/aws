name: ‚ôæÔ∏è Heal The Art: AI Audit & AWS Push

on:
  push:
    branches: [ main ]

jobs:
  audit-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # Required for AWS OIDC "Handshake"
      contents: write   # Required for pushing dashboard updates to GitHub

    steps:
      - name: üõ∞Ô∏è Step 1: Initialize Repository
        uses: actions/checkout@v4

      # --- AI AUDIT SECTION ---
      - name: üîí Step 2: Run Triple Audit (Security, HR, Legal)
        run: |
          # DYNAMIC SEARCH: Find tokens.json even with spaces in folders
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          
          if [ -z "$TARGET_FILE" ]; then
            echo "SEC_RES=‚ùå FILE_MISSING" >> $GITHUB_ENV
            echo "HR_RES=‚ùå FILE_MISSING" >> $GITHUB_ENV
          else
            # Security: Look for AWS secrets or high-entropy strings
            if grep -qE "AKIA[0-9A-Z]{16}" "$TARGET_FILE" 2>/dev/null; then SEC="‚ùå SEC_FAIL"; else SEC="‚úÖ SEC_OK"; fi
            
            # HR: Look for inclusive language (master/slave/blacklist/whitelist)
            if grep -qiE "master|slave|blacklist|whitelist" "$TARGET_FILE" 2>/dev/null; then HR="‚ö†Ô∏è HR_WARN"; else HR="‚úÖ HR_OK"; fi
            
            echo "SEC_RES=$SEC" >> $GITHUB_ENV
            echo "HR_RES=$HR" >> $GITHUB_ENV
          fi
          
          # Legal: Look for LICENSE file in root
          if [ -f "LICENSE" ]; then LEG="‚úÖ LEG_OK"; else LEG="‚ùå LEG_FAIL"; fi
          echo "LEG_RES=$LEG" >> $GITHUB_ENV

      - name: üñ•Ô∏è Step 3: Heal index.html Dashboard
        run: |
          # Inject the audit results into your dashboard placeholders
          sed -i "s/{{SEC_AUDIT}}/${{ env.SEC_RES }}/g" index.html
          sed -i "s/{{HR_AUDIT}}/${{ env.HR_RES }}/g" index.html
          sed -i "s/{{LEGAL_AUDIT}}/${{ env.LEG_RES }}/g" index.html
          sed -i "s/{{LAST_RUN}}/$(date)/g" index.html

      # --- AWS DEPLOYMENT SECTION ---
      - name: üîê Step 4: AWS Authentication
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # This full ARN fixes the "Source Account ID" error
          role-to-assume: arn:aws:iam::249746593588:role/DesignSystemStack-CustomS3AutoDeleteObjectsCustomRe-wK8fy5Wb6uJl
          aws-region: us-east-1

      - name: üöÄ Step 5: Optimize & Push to S3
        run: |
          TARGET_FILE=$(find . -iname "tokens.json" | head -n 1)
          
          # Push raw tokens
          aws s3 cp "$TARGET_FILE" s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.json          
          
          # AI Step: Generate and push minified speed-optimized version
          python -c "import json; data=json.load(open('$TARGET_FILE')); json.dump(data, open('tokens.min.json', 'w'), separators=(',', ':'))"
          aws s3 cp tokens.min.json s3://designsystemstack-designsystembucket5acc6a0c-rnswnyj3sv4f/tokens.min.json

      - name: üîÑ Step 6: Close the Feedback Loop
        run: |
          git config --global user.name 'AI-Auditor'
          git config --global user.email 'actions@github.com'
          git add index.html
          git commit -m 'ü§ñ AI Dashboard Sync: Healed Architecture' || echo 'No changes'
          git push
